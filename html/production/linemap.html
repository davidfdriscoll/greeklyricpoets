<!DOCTYPE html>
<html>
  <head>
    <title>NETWORK FOR THE STUDY OF ARCHAIC AND CLASSICAL GREEK SONG -- GREEK LYRIC POETS MAP | CartoDB.js</title>

    <link type="text/css" rel="stylesheet" href="orbis.css" />
    <link type="text/css" rel="stylesheet" href="lyricmapping.css" />
    <link type="text/css" rel="stylesheet" href="chosen.min.css" />
    <link rel="stylesheet" href="css/iThing.css" type="text/css" />
    <link href='http://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    
    <link rel="shortcut icon" href="http://cartodb.com/assets/favicon.ico" />
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css" />
    <!--[if lte IE 8]>
      <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.ie.css" />
    <![endif]-->
    
</head>
  
<body>
  
  <div id="map"></div>

  <div class="controlsDiv" id="controlbar">
    <div id="controlbarScroller";>
      
    <div id="modeSelection">
      <div style="background: white" class="mainlinksDiv">
	<a class="mainlinks" href="bubblemap.html">PLACES</a>
      </div>  
      <div style="float:right" class="mainlinksDiv" id="navbar_selected">
	<a class="mainlinks" href="linemap.html">TRAVEL</a>
      </div>
    </div>
    
    <div style="width: 292px; margin: 0 auto;" id="slider"></div>
      
    <div class="buttonContainer" style="background: white;">            
      <fieldset style="border: none;" id="cityForm" class="priorityForm">
        <div style="color:gray;padding-right:5px;display: inline-block;margin-top: 3px;" >POET: </div>
	
        <input type="radio" value="0" name="city" id="poet_23">
        <label for="poet_23" class="priority-picker-label">Ariphron</label>
	
        <input type="radio" value="1" name="city" id="poet_11">
        <label for="poet_11" class="priority-picker-label">Bakkhiadas</label>
	
        <input type="radio" value="2" name="city" id="poet_61">
        <label for="poet_61" class="priority-picker-label">Dion</label>
	
	<input type="radio" value="0" name="city" id="poet_62">
        <label for="poet_62" class="priority-picker-label">Dionysius of Chios</label>
	
        <input type="radio" value="1" name="city" id="poet_43">
        <label for="poet_43" class="priority-picker-label">Euangelos</label>
	
        <input type="radio" value="2" name="city" id="poet_44">
        <label for="poet_44" class="priority-picker-label">Eumelos</label>
	
        <input type="radio" value="0" name="city" id="poet_55">
        <label for="poet_55" class="priority-picker-label">Ion of Chios</label>
	
        <input type="radio" value="1" name="city" id="poet_51">
        <label for="poet_51" class="priority-picker-label">Khairis</label>
	
        <input type="radio" value="2" name="city" id="poet_20">
        <label for="poet_20" class="priority-picker-label">Krateuas</label>
	
	<input type="radio" value="0" name="city" id="poet_47">
        <label for="poet_47" class="priority-picker-label">Kydides</label>
	
        <input type="radio" value="1" name="city" id="poet_3">
        <label for="poet_3" class="priority-picker-label">Licymnius</label>
	
        <input type="radio" value="2" name="city" id="poet_52">
        <label for="poet_52" class="priority-picker-label">Magnes</label>

	<input type="radio" value="0" name="city" id="poet_1">
        <label for="poet_1" class="priority-picker-label">Melanippides</label>
	
        <input type="radio" value="1" name="city" id="poet_24">
        <label for="poet_24" class="priority-picker-label">Philoxenus of Cythera</label>
	
        <input type="radio" value="2" name="city" id="poet_5">
        <label for="poet_5" class="priority-picker-label">Phrynis</label>
	
	<input type="radio" value="0" name="city" id="poet_26">
        <label for="poet_26" class="priority-picker-label">Polyidus</label>
	
        <input type="radio" value="1" name="city" id="poet_2">
        <label for="poet_2" class="priority-picker-label">Pronomus</label>
	
        <input type="radio" value="2" name="city" id="poet_7">
        <label for="poet_7" class="priority-picker-label">Telestes</label>
	
        <input type="radio" value="0" name="city" id="poet_45">
        <label for="poet_45" class="priority-picker-label">Thespis</label>
	
        <input type="radio" value="1" name="city" id="poet_6">
        <label for="poet_6" class="priority-picker-label">Timotheus</label>
	
        <input type="radio" value="2" name="city" id="poet_18">
        <label for="poet_18" class="priority-picker-label">-es</label>
      </fieldset>
    </div>
    
    <div class="buttonContainer" style="background: white;">            
      <fieldset style="border: none;" id="genreForm" class="genreForm">
        <div style="color:gray;padding-right:5px;display: inline-block;margin-top: 3px;" >ORIGIN: </div>
	
        <input type="radio" value="0" name="city" id="origin_2">
        <label for="origin_2" class="genre-picker-label">Athens</label>
	
        <input type="radio" value="1" name="city" id="origin_6">
        <label for="origin_6" class="genre-picker-label">Chios</label>
	
        <input type="radio" value="2" name="city" id="origin_35">
        <label for="origin_35" class="genre-picker-label">Cythera</label>
	
	<input type="radio" value="0" name="city" id="origin_32">
        <label for="origin_32" class="genre-picker-label">Elis</label>
	
        <input type="radio" value="1" name="city" id="origin_31">
        <label for="origin_31" class="genre-picker-label">Hermione</label>
	
        <input type="radio" value="2" name="city" id="origin_1">
        <label for="origin_1" class="genre-picker-label">Melos</label>
	
	<input type="radio" value="0" name="city" id="origin_9">
        <label for="origin_9" class="genre-picker-label">Miletus</label>
	
        <input type="radio" value="1" name="city" id="origin_8">
        <label for="origin_8" class="genre-picker-label">Mytilene</label>
	
        <input type="radio" value="2" name="city" id="origin_12">
        <label for="origin_12" class="genre-picker-label">Selinus</label>
	
	<input type="radio" value="2" name="city" id="origin_22">
        <label for="origin_22" class="genre-picker-label">Selymbria</label>
	
        <input type="radio" value="1" name="city" id="origin_13">
        <label for="origin_13" class="genre-picker-label">Sicyon</label>
	
        <input type="radio" value="2" name="city" id="origin_19">
        <label for="origin_19" class="genre-picker-label">Tarentum</label>
	
	<input type="radio" value="0" name="city" id="origin_3">
        <label for="origin_3" class="genre-picker-label">Thebes</label>
	
        <input type="radio" value="1" name="city" id="origin_34">
        <label for="origin_34" class="genre-picker-label">Thessaly</label>
      </fieldset>
    </div>
      
      <div class="buttonContainer" style="background: white;">            
      <fieldset style="border: none;" id="instrumentForm" class="instrumentForm">
        <div style="color:gray;padding-right:5px;display: inline-block;margin-top: 3px;" >DESTINATION: </div>
	
        <input type="radio" value="0" name="city" id="destination_2">
        <label for="destination_2" class="instrument-picker-label">Athens</label>
	
        <input type="radio" value="1" name="city" id="destination_4">
        <label for="destination_4" class="instrument-picker-label">Chalcis</label>
	
        <input type="radio" value="2" name="city" id="destination_20">
        <label for="destination_20" class="instrument-picker-label">Colophon</label>
	
	<input type="radio" value="2" name="city" id="destination_5">
        <label for="destination_5" class="instrument-picker-label">Delos</label>
	
        <input type="radio" value="0" name="city" id="destination_30">
        <label for="destination_30" class="instrument-picker-label">Delphi</label>
	
        <input type="radio" value="1" name="city" id="destination_11">
        <label for="destination_11" class="instrument-picker-label">Ephesus</label>
	
        <input type="radio" value="2" name="city" id="destination_7">
        <label for="destination_7" class="instrument-picker-label">Leontini</label>
	
	<input type="radio" value="2" name="city" id="destination_14">
        <label for="destination_14" class="instrument-picker-label">Locri</label>
	
        <input type="radio" value="0" name="city" id="destination_33">
        <label for="destination_33" class="instrument-picker-label">Macedonia</label>
	
        <input type="radio" value="1" name="city" id="destination_15">
        <label for="destination_15" class="instrument-picker-label">Rhegium</label>
	
        <input type="radio" value="2" name="city" id="destination_13">
        <label for="destination_13" class="instrument-picker-label">Sicyon</label>
	
	<input type="radio" value="2" name="city" id="destination_10">
        <label for="destination_10" class="instrument-picker-label">Sparta</label>
	
        <input type="radio" value="2" name="city" id="destination_18">
        <label for="destination_18" class="instrument-picker-label">Syracuse</label>
	
	<input type="radio" value="2" name="city" id="destination_19">
        <label for="destination_19" class="instrument-picker-label">Tarentum</label>
      </fieldset>
    </div>
    
  </div>
  </div>
  </div>
  </div>  
    
    <!--Custom html for the infowindow customization-->
    <!--You can write simple html or use Mustache templates http://mustache.github.com/-->
    <!--Content.data contains the field info-->
    <!--Content.data is determined by the UI on the cartodb webpage.-->
    <!--In order for the following to work, you must run a query that gives the columns selected_number and selected_names, and then select those-->
    <script type="infowindow/html" id="infowindow_template">
      <div class="cartodb-popup">
        <a href="#close" class="cartodb-popup-close-button close">x</a>
         <div class="cartodb-popup-content-wrapper">
           <div class="cartodb-popup-cont">
            <h3>{{content.data.city_name}}</h3>
	    <p>Number selected: {{content.data.selected_number}}</p>
	    <p>Names selected: {{content.data.selected_names}}</p>
           </div>
         </div>
         <div class="cartodb-popup-tip-container"></div>
      </div>
    </script>

    <!-- include google maps library *before* load cartodb.js -->
    <script src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <!-- include cartodb.js library -->
    <script src="http://libs.cartocdn.com/cartodb.js/v3/cartodb.uncompressed.js"></script>

    <script>
	// create layer selector
      function createSelector(vis, layers) {
        var sql = new cartodb.SQL({ user: 'dfdrisco' });

        var $options = $('#controlbar input');
	  $options.click(function(e) {
          // get the button of the selected layer
          var $li = $(e.target);
	  var firstCall = true;
	  var i = 0;
	  var query1;
	  var query2;
	  var sublayer1 = layers[1].getSubLayer(0);
	  var sublayer2 = layers[1].getSubLayer(1);
          
          // deselect all_poets and toggle the clicked one
/*          $('#all_poets').removeClass('selected');
	  $options.removeClass('selected');
          $li.addClass('selected');
		  
	  //if all poets selected or nothing selected show all poets; otherwise, update query
	  if($li.attr('id')=='all_poets' || $options.hasClass('selected')==false) {
	    $options.removeClass('selected');
	    $('#all_poets').addClass('selected');
	    sublayer1.setSQL("select * from poets_lines");
	    query2 = createTotalPoetsQuery();
	    sublayer2.setSQL(query2);
	  }
	  else { */
	    
	    // choose query for lines data
	    firstCall = true;
	    for (i=1; i <= 100; i++) {		
		    if($('#poet_'+i).is(':checked')) {
			    if(firstCall == true) {
				    firstCall = false;
				    query1 = [
					    "select * from poets_lines where poetid = ",
					    i,
					    " "
				    ].join("");
			    }
			    else {
				    query1 = query1 + "OR poetid = " + i + " ";
			    }
		    }
		    if($('#origin_'+i).is(':checked')) {
			    if(firstCall == true) {
				    firstCall = false;
				    query1 = [
					    "select * from poets_lines where birth_cityid = ",
					    i,
					    " "
				    ].join("");
			    }
			    else {
				    query1 = query1 + "OR birth_cityid = " + i + " ";
			    }
		    }
		    if($('#destination_'+i).is(':checked')) {
			    if(firstCall == true) {
				    firstCall = false;
				    query1 = [
					    "select * from poets_lines where other_cityid = ",
					    i,
					    " "
				    ].join("");
			    }
			    else {
				    query1 = query1 + "OR birth_cityid = " + i + " ";
			    }
		    }
	    }
	    sublayer1.setSQL(query1);
	    console.log(query1);
	    
	    // choose query for cities data
	    query2 = "SELECT cities.cartodb_id, cities.the_geom, cities.the_geom_webmercator, cities.city_name, cities.government, sorted_poets.cityid, COUNT(sorted_poets.cityid) as selected_number, string_agg(sorted_poets.sources, ', ') as selected_sources, string_agg(sorted_poets.poet_name, ', ') as selected_names, string_agg(sorted_poets.poet_link, ', ') as selected_links FROM cities, (SELECT poets.poetid, poets.poet_name, poets.poet_link, poets.sources, poets_cities.cityid FROM poets, poets_cities WHERE poets.poetid = poets_cities.poetid AND (";
	    firstCall = true;
	    for (i=1; i <= 100; i++) {		
		    if($('#poet_'+i).is(':checked')) {
			    if(firstCall == true) {
				    firstCall = false;
				    query2 = query2 + [
					    "poets.poetid = ",
					    i,
					    " "
				    ].join("");
			    }
			    else {
				    query2 = query2 + "OR poets.poetid = " + i + " ";
			    }
		    }
		    if($('#origin_'+i).is(':checked')) {
			    if(firstCall == true) {
				    firstCall = false;
				    query2 = query2 + [
					    "poets_cities.cityid = ",
					    i,
					    " "
				    ].join("");
			    }
			    else {
				    query2 = query2 + "OR poets_cities.cityid = " + i + " ";
			    }
		    }
		    if($('#destination_'+i).is(':checked')) {
			    if(firstCall == true) {
				    firstCall = false;
				    query2 = query2 + [
					    "poets_cities.cityid = ",
					    i,
					    " "
				    ].join("");
			    }
			    else {
				    query2 = query2 + "OR poets_cities.cityid = " + i + " ";
			    }
		    }
	    }
	    query2 = query2 + ") ORDER BY cityid ASC, poet_name ASC) sorted_poets WHERE cities.cityid = sorted_poets.cityid GROUP BY sorted_poets.cityid, cities.the_geom, cities.the_geom_webmercator, cities.city_name, cities.cartodb_id";
	    console.log(query2);
	    sublayer2.setSQL(query2);
//	  }
		  
        });
      }

	  function createTotalPoetsQuery() {
		var query = [
			"SELECT ",
			"	cities.cartodb_id, ",
			"	cities.the_geom, ",
			"	cities.the_geom_webmercator, ",
			"	cities.city_name, ",
			"	cities.government, ",
			"	sorted_poets.cityid, ",
			"	COUNT(sorted_poets.cityid) as selected_number, ",
			"	string_agg(sorted_poets.poet_name, ', ') as selected_names, ",
			"   	string_agg(sorted_poets.sources, ', ') as selected_sources, ",
			"	string_agg(sorted_poets.poet_link, ', ') as selected_links ",
			"FROM cities, ",
			"	(SELECT ",
			"		poets.poetid, ",
			"		poets.poet_name, ",
			"		poets.sources, ",
			"		poets.poet_link, ",
			"		poets_cities.cityid ",
			"		FROM poets, poets_cities ",
			"		WHERE poets.poetid = poets_cities.poetid ",
			"		ORDER BY cityid ASC, poet_name ASC) sorted_poets ",
			"WHERE cities.cityid = sorted_poets.cityid ",
			"GROUP BY sorted_poets.cityid, cities.the_geom, cities.the_geom_webmercator, cities.city_name, cities.cartodb_id"
		].join("");
		return query;
	}

	  function createBubbleVisualization(selectedData) {
		var bubble =
			['#cities{',
			  'marker-fill: #B81609;',
			  'marker-line-color: #FFF;',
			  'marker-line-width: 2;',
			  'marker-line-opacity: 1;',
			  'marker-opacity: 0.9;',
			  'marker-placement: point;',
			  'marker-type: ellipse;',
			  'marker-allow-overlap: true;',
			  'marker-clip: false;',
			  'marker-multi-policy: largest;',
			  'marker-width: 10.0;',
			'}',
/*			'#cities::labels ', 
			'[',selectedData,'>=8][zoom>5], ',
			'[',selectedData,'>=2][zoom>6], ',
			'[',selectedData,'>=1][zoom>7] ', 
			'{',
			'  text-name: [city_name];',
			'  text-face-name: "Open Sans Regular";',
			'  text-size: 15;',
			'  text-fill: #000;',
			'  text-allow-overlap: true;',
			'  text-halo-fill: #FFF;',
			'  text-halo-radius: 1;',
			'  text-placement-type: simple;',
			'  text-placements: "N,S,E,W,NE,SE,NW,SW,16,14,12";',
			'  text-dy: 3;',
			'  text-dx: 3;',
			'}',  */
			].join('');
		return bubble;
		}
	
      
      function getParameterByName(name) {
	  name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
	  var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
	      results = regex.exec(location.search);
	  return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
      }      
	  
      function main() {
        cartodb.createVis('map', 'http://greeklyricpoets.cartodb.com/api/v2/viz/5412ef5c-128d-11e3-8b55-8149b805c7e0/viz.json', {
          tiles_loader: false,
          center_lat: 38.95,
          center_lon: 22.38,
          zoom: 6
        })
        .done(function(vis, layers) {
	  // layer 0 is the base layer, layer 1 is cartodb layer
	  var sublayer = layers[1].getSubLayer(0);
	  var sublayer2;
	  var poetid = getParameterByName("poetid");
	  var query = createTotalPoetsQuery();
	  var css = createBubbleVisualization("selected_number");
	  
	  sublayer.set({ 'interactivity': ['cartodb_id', 'poet_name', 'birth_city_name', 'other_city_name', 'instrument_names', 'genre_names', 'date_names', 'sources'] });
	  
	  vis.addOverlay({
		  type: 'infobox',
		  template: "<h3>{{poet_name}}</h3><p>Place of birth: {{birth_city_name}}</p><p>Place of Performance: {{other_city_name}}</p><p>Instruments: {{instrument_names}}</p><p>Genres: {{genre_names}}</p><p>Dates: {{date_names}}</p><p>Sources: {{sources}}</p>",
		  width: 300,
		  position: 'bottom|left'
	  });

	  layers[1].createSubLayer({sql: query, cartocss: css } );
	  sublayer2 = layers[1].getSubLayer(1);
	  sublayer2.set({ 'interactivity': ['cartodb_id', 'city_name', 'selected_number', 'selected_names', 'selected_sources'] });
	  sublayer2.infowindow.set('template', $('#infowindow_template').html());
	  
	  if (poetid != "") {
	    $("#poet_" + poetid).addClass('selected');
	    sublayer.setSQL("SELECT * FROM poets_lines WHERE poetid = " + poetid);
	    sublayer2.setSQL("SELECT cities.cartodb_id, cities.the_geom, cities.the_geom_webmercator, cities.city_name, cities.government, sorted_poets.cityid, COUNT(sorted_poets.cityid) as selected_number, string_agg(sorted_poets.sources, ', ') as selected_sources, string_agg(sorted_poets.poet_name, ', ') as selected_names, string_agg(sorted_poets.poet_link, ', ') as selected_links FROM cities, (SELECT poets.poetid, poets.poet_name, poets.poet_link, poets.sources, poets_cities.cityid FROM poets, poets_cities WHERE poets.poetid = poets_cities.poetid AND poets.poetid = " + poetid + " ORDER BY cityid ASC, poet_name ASC) sorted_poets WHERE cities.cityid = sorted_poets.cityid GROUP BY sorted_poets.cityid, cities.the_geom, cities.the_geom_webmercator, cities.city_name, cities.cartodb_id");
	  }
	  else {
	    $('#all_poets').addClass('selected');
	    sublayer.setSQL("SELECT * FROM poets_lines");
	  }
	  	  
	  createSelector(vis, layers);
        })
        .error(function(err) {
          console.log(err);
        });
      }

      window.onload = main;
    </script>
    
    <script src="bootstrap/js/jquery.js"></script>  
    <script src="bootstrap/js/bootstrap-dropdown.js"></script> 
  </body>
</html>