<!DOCTYPE html>
<html>
  <head>
    <title>NETWORK FOR THE STUDY OF ARCHAIC AND CLASSICAL GREEK SONG -- GREEK LYRIC POETS MAP | CartoDB.js</title>

    <link type="text/css" rel="stylesheet" href="orbis.css" />
    <link type="text/css" rel="stylesheet" href="lyricmapping.css" />
    <link type="text/css" rel="stylesheet" href="chosen.min.css" />
    <link rel="stylesheet" href="css/iThing.css" type="text/css" />
    <link href='http://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    
    <link rel="shortcut icon" href="http://cartodb.com/assets/favicon.ico" />
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css" />
    <!--[if lte IE 8]>
      <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.ie.css" />
    <![endif]-->
    
</head>
  
<body>
  
  <div id="map"></div>

  <div class="controlsDiv" id="controlbar"  style="width: 500px; top: 10px;">
    <div id="controlbarScroller";>
      
    <div id="modeSelection">
      <div class="mainlinksDiv" id="navbar_selected">
	<a class="mainlinks" href="bubblemap.html">PLACES</a>
      </div>  
      <div style="float:right" class="mainlinksDiv">
	<a style="border-bottom: 4px solid; border-bottom-color: #c72f2a;" class="mainlinks" href="linemap.html">TRAVEL</a>
      </div>
    </div>
    
    <div style="width: 292px; margin: 0 auto;" id="slider"></div>
      
    <div class="buttonContainer" style="background: white;">            
      <fieldset style="border: none;" id="cityForm" class="priorityForm">
        <div style="color:gray;padding-right:5px;display: inline-block;margin-top: 3px;" >POET: </div>
	
        <input type="radio" value="0" name="city" id="poet_93">
        <label for="poet_93" class="priority-picker-label">Alcman</label>
	
        <input type="radio" value="0" name="city" id="poet_94">
        <label for="poet_94" class="priority-picker-label">Anacreon</label>
	
        <input type="radio" value="0" name="city" id="poet_96">
        <label for="poet_96" class="priority-picker-label">Apollodorus</label>
	
        <input type="radio" value="0" name="city" id="poet_97">
        <label for="poet_97" class="priority-picker-label">Archilochus</label>
	
        <input type="radio" value="0" name="city" id="poet_98">
        <label for="poet_23" class="priority-picker-label">Arion</label>
	
        <input type="radio" value="0" name="city" id="poet_23">
        <label for="poet_23" class="priority-picker-label">Ariphron</label>
	
        <input type="radio" value="0" name="city" id="poet_100">
        <label for="poet_100" class="priority-picker-label">Bacchylides</label>
	
        <input type="radio" value="1" name="city" id="poet_107">
        <label for="poet_107" class="priority-picker-label">Demodocus</label>
	
        <input type="radio" value="0" name="city" id="poet_59">
        <label for="poet_59" class="priority-picker-label">Diagoras</label>
	
        <input type="radio" value="2" name="city" id="poet_61">
        <label for="poet_61" class="priority-picker-label">Dion</label>
	
		<input type="radio" value="0" name="city" id="poet_62">
        <label for="poet_62" class="priority-picker-label">Dionysius of Chios</label>
	
        <input type="radio" value="0" name="city" id="poet_111">
        <label for="poet_111" class="priority-picker-label">Echembrotus</label>
	
        <input type="radio" value="1" name="city" id="poet_43">
        <label for="poet_43" class="priority-picker-label">Euangelos</label>
	
        <input type="radio" value="2" name="city" id="poet_112">
        <label for="poet_112" class="priority-picker-label">Eumelos #1</label>
	
        <input type="radio" value="2" name="city" id="poet_44">
        <label for="poet_44" class="priority-picker-label">Eumelos #2</label>
	
        <input type="radio" value="2" name="city" id="poet_113">
        <label for="poet_113" class="priority-picker-label">Eunicus</label>
	
        <input type="radio" value="2" name="city" id="poet_42">
        <label for="poet_42" class="priority-picker-label">Exekestides</label>
	
        <input type="radio" value="2" name="city" id="poet_117">
        <label for="poet_117" class="priority-picker-label">Ibycus</label>
	
        <input type="radio" value="2" name="city" id="poet_118">
        <label for="poet_118" class="priority-picker-label">Ion</label>
	
        <input type="radio" value="0" name="city" id="poet_55">
        <label for="poet_55" class="priority-picker-label">Ion of Chios</label>
	
        <input type="radio" value="1" name="city" id="poet_51">
        <label for="poet_51" class="priority-picker-label">Khairis</label>
	
        <input type="radio" value="2" name="city" id="poet_20">
        <label for="poet_20" class="priority-picker-label">Krateuas</label>
	
		<input type="radio" value="0" name="city" id="poet_47">
        <label for="poet_47" class="priority-picker-label">Kydides</label>
	
        <input type="radio" value="2" name="city" id="poet_120">
        <label for="poet_120" class="priority-picker-label">Lamprus</label>
	
        <input type="radio" value="2" name="city" id="poet_121">
        <label for="poet_121" class="priority-picker-label">Lasus</label>
	
        <input type="radio" value="1" name="city" id="poet_3">
        <label for="poet_3" class="priority-picker-label">Licymnius</label>
	
        <input type="radio" value="2" name="city" id="poet_52">
        <label for="poet_52" class="priority-picker-label">Magnes</label>

		<input type="radio" value="0" name="city" id="poet_1">
        <label for="poet_1" class="priority-picker-label">Melanippides</label>
	
        <input type="radio" value="1" name="city" id="poet_24">
        <label for="poet_24" class="priority-picker-label">Philoxenus of Cythera</label>
	
        <input type="radio" value="2" name="city" id="poet_5">
        <label for="poet_5" class="priority-picker-label">Phrynis</label>
	
		<input type="radio" value="0" name="city" id="poet_26">
        <label for="poet_26" class="priority-picker-label">Polyidus</label>
	
        <input type="radio" value="2" name="city" id="poet_129">
        <label for="poet_129" class="priority-picker-label">Pratinas</label>
	
        <input type="radio" value="1" name="city" id="poet_2">
        <label for="poet_2" class="priority-picker-label">Pronomus</label>
	
        <input type="radio" value="2" name="city" id="poet_131">
        <label for="poet_131" class="priority-picker-label">Sacadas</label>
	
        <input type="radio" value="2" name="city" id="poet_132">
        <label for="poet_132" class="priority-picker-label">Sappho</label>
	
        <input type="radio" value="2" name="city" id="poet_135">
        <label for="poet_135" class="priority-picker-label">Simonides</label>
	
        <input type="radio" value="2" name="city" id="poet_136">
        <label for="poet_136" class="priority-picker-label">Solon</label>
	
        <input type="radio" value="2" name="city" id="poet_138">
        <label for="poet_138" class="priority-picker-label">Stesichorus</label>
	
        <input type="radio" value="2" name="city" id="poet_139">
        <label for="poet_139" class="priority-picker-label">Susarion</label>
	
        <input type="radio" value="2" name="city" id="poet_7">
        <label for="poet_7" class="priority-picker-label">Telestes</label>
	
        <input type="radio" value="2" name="city" id="poet_141">
        <label for="poet_141" class="priority-picker-label">Terpander</label>
	
        <input type="radio" value="2" name="city" id="poet_142">
        <label for="poet_142" class="priority-picker-label">Thaletas</label>
	
        <input type="radio" value="0" name="city" id="poet_45">
        <label for="poet_45" class="priority-picker-label">Thespis</label>
	
        <input type="radio" value="1" name="city" id="poet_6">
        <label for="poet_6" class="priority-picker-label">Timotheus</label>
	
        <input type="radio" value="2" name="city" id="poet_145">
        <label for="poet_145" class="priority-picker-label">Tyrtaeus</label>
	
        <input type="radio" value="2" name="city" id="poet_148">
        <label for="poet_148" class="priority-picker-label">Xenophanes</label>
	
        <input type="radio" value="2" name="city" id="poet_18">
        <label for="poet_18" class="priority-picker-label">-es</label>
      </fieldset>
    </div>
    
    <div class="buttonContainer" style="background: white;">            
      <fieldset style="border: none;" id="instrumentForm" class="instrumentForm">
        <div style="color:gray;padding-right:5px;display: inline-block;margin-top: 3px;" >DESTINATION: </div>
	
        <input type="radio" value="0" name="city" id="destination_65">
        <label for="destination_65" class="instrument-picker-label">Abdera</label>
	
        <input type="radio" value="0" name="city" id="destination_79">
        <label for="destination_79" class="instrument-picker-label">Akragas</label>
	
        <input type="radio" value="0" name="city" id="destination_77">
        <label for="destination_77" class="instrument-picker-label">Amorgos</label>
	
        <input type="radio" value="0" name="city" id="destination_54">
        <label for="destination_54" class="instrument-picker-label">Arcadia</label>
	
        <input type="radio" value="0" name="city" id="destination_38">
        <label for="destination_38" class="instrument-picker-label">Argos</label>
	
        <input type="radio" value="0" name="city" id="destination_2">
        <label for="destination_2" class="instrument-picker-label">Athens</label>
	
        <input type="radio" value="1" name="city" id="destination_4">
        <label for="destination_4" class="instrument-picker-label">Chalcis</label>
	
        <input type="radio" value="0" name="city" id="destination_2">
        <label for="destination_2" class="instrument-picker-label">Athens</label>
	
        <input type="radio" value="2" name="city" id="destination_75">
        <label for="destination_75" class="instrument-picker-label">Clazomenae</label>
	
        <input type="radio" value="0" name="city" id="destination_20">
        <label for="destination_20" class="instrument-picker-label">Colophon</label>
	
        <input type="radio" value="0" name="city" id="destination_48">
        <label for="destination_48" class="instrument-picker-label">Corinth</label>
	
		<input type="radio" value="2" name="city" id="destination_5">
        <label for="destination_5" class="instrument-picker-label">Delos</label>
	
        <input type="radio" value="0" name="city" id="destination_30">
        <label for="destination_30" class="instrument-picker-label">Delphi</label>
	
        <input type="radio" value="1" name="city" id="destination_11">
        <label for="destination_11" class="instrument-picker-label">Ephesus</label>
	
        <input type="radio" value="0" name="city" id="destination_78">
        <label for="destination_78" class="instrument-picker-label">Gela</label>
	
        <input type="radio" value="0" name="city" id="destination_16">
        <label for="destination_16" class="instrument-picker-label">Helicon</label>
	
        <input type="radio" value="0" name="city" id="destination_74">
        <label for="destination_74" class="instrument-picker-label">Heracleia (Trachinea)</label>
	
        <input type="radio" value="0" name="city" id="destination_73">
        <label for="destination_73" class="instrument-picker-label">Ikaros</label>
	
        <input type="radio" value="0" name="city" id="destination_64">
        <label for="destination_64" class="instrument-picker-label">Katane</label>
	
        <input type="radio" value="0" name="city" id="destination_81">
        <label for="destination_81" class="instrument-picker-label">Krannon</label>
	
        <input type="radio" value="2" name="city" id="destination_7">
        <label for="destination_7" class="instrument-picker-label">Leontini</label>
	
        <input type="radio" value="0" name="city" id="destination_21">
        <label for="destination_21" class="instrument-picker-label">Leucas</label>
	
		<input type="radio" value="2" name="city" id="destination_14">
        <label for="destination_14" class="instrument-picker-label">Locri</label>
	
        <input type="radio" value="0" name="city" id="destination_84">
        <label for="destination_84" class="instrument-picker-label">Locris Ozolia</label>
	
        <input type="radio" value="0" name="city" id="destination_33">
        <label for="destination_33" class="instrument-picker-label">Macedonia</label>
	
        <input type="radio" value="0" name="city" id="destination_44">
        <label for="destination_44" class="instrument-picker-label">Magnesia-ad-Sipylum</label>
	
        <input type="radio" value="0" name="city" id="destination_70">
        <label for="destination_70" class="instrument-picker-label">Mantineia</label>
	
        <input type="radio" value="0" name="city" id="destination_49">
        <label for="destination_49" class="instrument-picker-label">Messena</label>
	
        <input type="radio" value="0" name="city" id="destination_9">
        <label for="destination_9" class="instrument-picker-label">Miletus</label>
	
        <input type="radio" value="0" name="city" id="destination_66">
        <label for="destination_66" class="instrument-picker-label">Naxos</label>
	
        <input type="radio" value="0" name="city" id="destination_83">
        <label for="destination_83" class="instrument-picker-label">Pallantion</label>
	
        <input type="radio" value="0" name="city" id="destination_39">
        <label for="destination_39" class="instrument-picker-label">Paros</label>
	
        <input type="radio" value="0" name="city" id="destination_71">
        <label for="destination_71" class="instrument-picker-label">Pellene</label>
	
        <input type="radio" value="0" name="city" id="destination_85">
        <label for="destination_85" class="instrument-picker-label">Persepolis</label>
	
        <input type="radio" value="0" name="city" id="destination_80">
        <label for="destination_80" class="instrument-picker-label">Pharsalos</label>
	
        <input type="radio" value="1" name="city" id="destination_15">
        <label for="destination_15" class="instrument-picker-label">Rhegium</label>
	
        <input type="radio" value="0" name="city" id="destination_82">
        <label for="destination_82" class="instrument-picker-label">Salamis</label>
	
        <input type="radio" value="0" name="city" id="destination_41">
        <label for="destination_41" class="instrument-picker-label">Samos</label>
	
        <input type="radio" value="0" name="city" id="destination_43">
        <label for="destination_43" class="instrument-picker-label">Sardis</label>
	
        <input type="radio" value="0" name="city" id="destination_68">
        <label for="destination_68" class="instrument-picker-label">Sicily</label>
	
        <input type="radio" value="2" name="city" id="destination_13">
        <label for="destination_13" class="instrument-picker-label">Sicyon</label>
	
        <input type="radio" value="0" name="city" id="destination_67">
        <label for="destination_67" class="instrument-picker-label">Siris</label>
	
        <input type="radio" value="0" name="city" id="destination_26">
        <label for="destination_26" class="instrument-picker-label">Soli (Cilicia)</label>

        <input type="radio" value="0" name="city" id="destination_63">
        <label for="destination_63" class="instrument-picker-label">Soli (Cyprus)</label>
	
	<input type="radio" value="2" name="city" id="destination_10">
        <label for="destination_10" class="instrument-picker-label">Sparta</label>
	
        <input type="radio" value="2" name="city" id="destination_18">
        <label for="destination_18" class="instrument-picker-label">Syracuse</label>
	
        <input type="radio" value="0" name="city" id="destination_19">
        <label for="destination_19" class="instrument-picker-label">Tainaron</label>
	
		<input type="radio" value="2" name="city" id="destination_19">
        <label for="destination_19" class="instrument-picker-label">Tarentum</label>
	
        <input type="radio" value="0" name="city" id="destination_40">
        <label for="destination_40" class="instrument-picker-label">Thasos</label>
	
        <input type="radio" value="0" name="city" id="destination_3">
        <label for="destination_3" class="instrument-picker-label">Thebes</label>

        <input type="radio" value="0" name="city" id="destination_76">
        <label for="destination_76" class="instrument-picker-label">Thespiai</label>
	
        <input type="radio" value="0" name="city" id="destination_72">
        <label for="destination_72" class="instrument-picker-label">Thurii</label>
      </fieldset>
    </div>
    
    <div class="buttonContainer" style="background: white;">            
      <fieldset style="border: none;" id="genreForm" class="genreForm">
        <div style="color:gray;padding-right:5px;display: inline-block;margin-top: 3px;" >ORIGIN: </div>

        <input type="radio" value="0" name="city" id="origin_59">
        <label for="origin_59" class="genre-picker-label">Antissa</label>

		<input type="radio" value="0" name="city" id="origin_54">
        <label for="origin_54" class="genre-picker-label">Arcadia</label>
	
        <input type="radio" value="0" name="city" id="origin_38">
        <label for="origin_38" class="genre-picker-label">Argos</label>
	
        <input type="radio" value="0" name="city" id="origin_2">
        <label for="origin_2" class="genre-picker-label">Athens</label>
	
        <input type="radio" value="1" name="city" id="origin_6">
        <label for="origin_6" class="genre-picker-label">Chios</label>
	
        <input type="radio" value="1" name="city" id="origin_20">
        <label for="origin_20" class="genre-picker-label">Colophon</label>

        <input type="radio" value="1" name="city" id="origin_48">
        <label for="origin_48" class="genre-picker-label">Corinth</label>

        <input type="radio" value="2" name="city" id="origin_35">
        <label for="origin_35" class="genre-picker-label">Cythera</label>
	
		<input type="radio" value="0" name="city" id="origin_32">
        <label for="origin_32" class="genre-picker-label">Elis</label>
	
        <input type="radio" value="1" name="city" id="origin_11">
        <label for="origin_6" class="genre-picker-label">Ephesus</label>
	
        <input type="radio" value="1" name="city" id="origin_56">
        <label for="origin_56" class="genre-picker-label">Eresos</label>
	
        <input type="radio" value="1" name="city" id="origin_50">
        <label for="origin_6" class="genre-picker-label">Erythrae</label>
	
        <input type="radio" value="1" name="city" id="origin_60">
        <label for="origin_60" class="genre-picker-label">Gortyn</label>
	
        <input type="radio" value="1" name="city" id="origin_31">
        <label for="origin_31" class="genre-picker-label">Hermione</label>
	
        <input type="radio" value="1" name="city" id="origin_23">
        <label for="origin_23" class="genre-picker-label">Himera</label>
	
        <input type="radio" value="1" name="city" id="origin_46">
        <label for="origin_46" class="genre-picker-label">Ioulis (Ceos)</label>
	
        <input type="radio" value="1" name="city" id="origin_47">
        <label for="origin_47" class="genre-picker-label">Leros</label>
	
        <input type="radio" value="1" name="city" id="origin_58">
        <label for="origin_58" class="genre-picker-label">Matauria</label>
	
        <input type="radio" value="1" name="city" id="origin_17">
        <label for="origin_17" class="genre-picker-label">Megara</label>
	
        <input type="radio" value="2" name="city" id="origin_1">
        <label for="origin_1" class="genre-picker-label">Melos</label>
	
        <input type="radio" value="1" name="city" id="origin_45">
        <label for="origin_45" class="genre-picker-label">Methymna</label>
	
		<input type="radio" value="0" name="city" id="origin_9">
        <label for="origin_9" class="genre-picker-label">Miletus</label>
	
        <input type="radio" value="1" name="city" id="origin_8">
        <label for="origin_8" class="genre-picker-label">Mytilene</label>
	
        <input type="radio" value="1" name="city" id="origin_39">
        <label for="origin_39" class="genre-picker-label">Paros</label>
	
        <input type="radio" value="1" name="city" id="origin_55">
        <label for="origin_55" class="genre-picker-label">Phleious</label>
	
        <input type="radio" value="1" name="city" id="origin_15">
        <label for="origin_15" class="genre-picker-label">Rhegium</label>
	
        <input type="radio" value="1" name="city" id="origin_61">
        <label for="origin_61" class="genre-picker-label">Rhodes</label>
	
        <input type="radio" value="1" name="city" id="origin_41">
        <label for="origin_41" class="genre-picker-label">Samos</label>
	
        <input type="radio" value="1" name="city" id="origin_43">
        <label for="origin_43" class="genre-picker-label">Sardis</label>
	
        <input type="radio" value="2" name="city" id="origin_12">
        <label for="origin_12" class="genre-picker-label">Selinus</label>
	
		<input type="radio" value="2" name="city" id="origin_22">
        <label for="origin_22" class="genre-picker-label">Selymbria</label>
	
        <input type="radio" value="1" name="city" id="origin_13">
        <label for="origin_13" class="genre-picker-label">Sicyon</label>
	
        <input type="radio" value="1" name="city" id="origin_36">
        <label for="origin_36" class="genre-picker-label">Smyrna</label>
	
        <input type="radio" value="1" name="city" id="origin_10">
        <label for="origin_10" class="genre-picker-label">Sparta</label>
	
        <input type="radio" value="2" name="city" id="origin_19">
        <label for="origin_19" class="genre-picker-label">Tarentum</label>
	
        <input type="radio" value="1" name="city" id="origin_42">
        <label for="origin_42" class="genre-picker-label">Teos</label>
	
		<input type="radio" value="0" name="city" id="origin_3">
        <label for="origin_3" class="genre-picker-label">Thebes</label>
	
        <input type="radio" value="1" name="city" id="origin_34">
        <label for="origin_34" class="genre-picker-label">Thessaly</label>
      </fieldset>
    </div>
	
    <div class="buttonContainer" style="background: white;">            
      <fieldset style="border: none;" id="genreForm" class="genreForm">
        <div style="color:gray;padding-right:5px;display: inline-block;margin-top: 3px;" >REGION: </div>

        <input type="radio" value="0" name="city" id="region_1">
        <label for="region_1" class="genre-picker-label">Magna Graecia</label>

		<input type="radio" value="0" name="city" id="region_2">
        <label for="region_2" class="genre-picker-label">Mainland Greece</label>
	
        <input type="radio" value="0" name="city" id="region_3">
        <label for="region_3" class="genre-picker-label">Aegean Islands</label>
		
        <input type="radio" value="0" name="city" id="region_4">
        <label for="region_4" class="genre-picker-label">Asia Minor</label>		
	
      </fieldset>
    </div>
    
  </div>
  </div>
  </div>
  </div>  
    
    <!--Custom html for the infowindow customization-->
    <!--You can write simple html or use Mustache templates http://mustache.github.com/-->
    <!--Content.data contains the field info-->
    <!--Content.data is determined by the UI on the cartodb webpage.-->
    <!--In order for the following to work, you must run a query that gives the columns selected_number and selected_names, and then select those-->
    <script type="infowindow/html" id="infowindow_template">
      <div class="cartodb-popup">
        <a href="#close" class="cartodb-popup-close-button close">x</a>
         <div class="cartodb-popup-content-wrapper">
           <div class="cartodb-popup-cont">
            <h3>{{content.data.city_name}}</h3>
	    <p>Number selected: {{content.data.selected_number}}</p>
	    <p>Names selected: {{content.data.selected_names}}</p>
           </div>
         </div>
         <div class="cartodb-popup-tip-container"></div>
      </div>
    </script>

    <!-- include google maps library *before* load cartodb.js -->
    <script src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <!-- include cartodb.js library -->
    <script src="http://libs.cartocdn.com/cartodb.js/v3/cartodb.uncompressed.js"></script>

    <script>
	// create layer selector
      function createSelector(vis, layers) {
        var sql = new cartodb.SQL({ user: 'dfdrisco' });

        var $options = $('#controlbar input');
	  $options.click(function(e) {
          // get the button of the selected layer
          var $li = $(e.target);
	  var firstCall = true;
	  var i = 0;
	  var query1;
	  var query2;
	  var sublayer1 = layers[1].getSubLayer(0);
	  var sublayer2 = layers[1].getSubLayer(1);
          
          // deselect all_poets and toggle the clicked one
/*          $('#all_poets').removeClass('selected');
	  $options.removeClass('selected');
          $li.addClass('selected');
		  
	  //if all poets selected or nothing selected show all poets; otherwise, update query
	  if($li.attr('id')=='all_poets' || $options.hasClass('selected')==false) {
	    $options.removeClass('selected');
	    $('#all_poets').addClass('selected');
	    sublayer1.setSQL("select * from poets_lines");
	    query2 = createTotalPoetsQuery();
	    sublayer2.setSQL(query2);
	  }
	  else { */
	    
	    // choose query for lines data
	    firstCall = true;
	    for (i=1; i <= 200; i++) {		
		    if($('#poet_'+i).is(':checked')) {
			    if(firstCall == true) {
				    firstCall = false;
				    query1 = [
					    "select * from poets_lines where poetid = ",
					    i,
					    " "
				    ].join("");
			    }
			    else {
				    query1 = query1 + "OR poetid = " + i + " ";
			    }
		    }
		    if($('#origin_'+i).is(':checked')) {
			    if(firstCall == true) {
				    firstCall = false;
				    query1 = [
					    "select * from poets_lines where birth_cityid = ",
					    i,
					    " "
				    ].join("");
			    }
			    else {
				    query1 = query1 + "OR birth_cityid = " + i + " ";
			    }
		    }
		    if($('#destination_'+i).is(':checked')) {
			    if(firstCall == true) {
				    firstCall = false;
				    query1 = [
					    "select * from poets_lines where other_cityid = ",
					    i,
					    " "
				    ].join("");
			    }
			    else {
				    query1 = query1 + "OR birth_cityid = " + i + " ";
			    }
		    }			
	    }
		if($('#region_1').is(':checked')) query1 = "SELECT * FROM poets_lines where birth_regionid = 7 or birth_regionid = 10 or other_regionid = 7 or other_regionid = 10";
		if($('#region_2').is(':checked')) query1 = "SELECT * FROM poets_lines where birth_regionid = 2 or birth_regionid = 3 or birth_regionid = 4 or birth_regionid = 9 or other_regionid = 2 or other_regionid = 3 or other_regionid = 4 or other_regionid = 9";
		if($('#region_3').is(':checked')) query1 = "SELECT * FROM poets_lines where birth_regionid = 1 or birth_regionid = 17 or birth_regionid = 13 or other_regionid = 1 or other_regionid = 17 or other_regionid = 13";
		if($('#region_4').is(':checked')) query1 = "SELECT * FROM poets_lines where birth_regionid = 6 or birth_regionid = 8 or birth_regionid = 14 or birth_regionid = 15 or birth_regionid = 16 or other_regionid = 6 or other_regionid = 8 or other_regionid = 14 or other_regionid = 15 or other_regionid = 16";
	    sublayer1.setSQL(query1);
		if (firstCall == false) sublayer1.setCartoCSS("#poets_lines { line-width: 3; line-opacity: 0.7; line-color: #fc1804; marker-fill: #fc1804; marker-file: url('http://web.stanford.edu/group/lyricmapping/arrow-16.svg'); marker-width: 10; marker-placement: point; marker-transform: rotate([arrow_angle]+90, 0, 0); }");
	    else sublayer1.setCartoCSS("#poets_lines { line-width: 1; line-opacity: 0.7; line-color: #fc1804; marker-fill: #fc1804; marker-file: url('http://web.stanford.edu/group/lyricmapping/arrow-16.svg'); marker-width: 5; marker-placement: point; marker-transform: rotate([arrow_angle]+90, 0, 0); }");
		console.log(query1);
	    
	    // choose query for cities data
	    query2 = "SELECT cities.cartodb_id, cities.the_geom, cities.the_geom_webmercator, cities.city_name, cities.government, sorted_poets.cityid, COUNT(sorted_poets.cityid) as selected_number, string_agg(sorted_poets.sources, ', ') as selected_sources, string_agg(sorted_poets.poet_name, ', ') as selected_names, string_agg(sorted_poets.poet_link, ', ') as selected_links FROM cities, (SELECT poets.poetid, poets.poet_name, poets.poet_link, poets.sources, poets_cities.cityid FROM poets, poets_cities WHERE poets.poetid = poets_cities.poetid AND (";
	    firstCall = true;
	    for (i=1; i <= 200; i++) {		
		    if($('#poet_'+i).is(':checked')) {
			    if(firstCall == true) {
				    firstCall = false;
				    query2 = query2 + [
					    "poets.poetid = ",
					    i,
					    " "
				    ].join("");
			    }
			    else {
				    query2 = query2 + "OR poets.poetid = " + i + " ";
			    }
		    }
		    if($('#origin_'+i).is(':checked')) {
			    if(firstCall == true) {
				    firstCall = false;
				    query2 = query2 + [
					    "poets_cities.cityid = ",
					    i,
					    " "
				    ].join("");
			    }
			    else {
				    query2 = query2 + "OR poets_cities.cityid = " + i + " ";
			    }
		    }
		    if($('#destination_'+i).is(':checked')) {
			    if(firstCall == true) {
				    firstCall = false;
				    query2 = query2 + [
					    "poets_cities.cityid = ",
					    i,
					    " "
				    ].join("");
			    }
			    else {
				    query2 = query2 + "OR poets_cities.cityid = " + i + " ";
			    }
		    }
	    }
		if (firstCall == false) {
	    query2 = query2 + ") ORDER BY cityid ASC, poet_name ASC) sorted_poets WHERE cities.cityid = sorted_poets.cityid GROUP BY sorted_poets.cityid, cities.the_geom, cities.the_geom_webmercator, cities.city_name, cities.cartodb_id";
		}
		else {
		  query2 = "SELECT cities.cartodb_id, cities.the_geom, cities.the_geom_webmercator, cities.city_name, cities.government, cities.cityid, '' as selected_number, '' as selected_sources, '' as selected_names, '' as selected_links from cities where "
		  if($('#region_1').is(':checked')) query2 = query2 + "regionid = 7 or regionid = 10";
		  if($('#region_2').is(':checked')) query2 = query2 + "regionid = 2 or regionid = 3 or regionid = 4 or regionid = 9";
		  if($('#region_3').is(':checked')) query2 = query2 + "regionid = 1 or regionid = 17 or regionid = 13 or regionid = 1 or regionid = 17 or regionid = 13";
		  if($('#region_4').is(':checked')) query2 = query2 + "regionid = 6 or regionid = 8 or regionid = 14 or regionid = 15 or regionid = 16";
		}
	    console.log(query2);
	    sublayer2.setSQL(query2);
//	  }
		  
        });
      }

	  function createTotalPoetsQuery() {
		var query = [
			"SELECT ",
			"	cities.cartodb_id, ",
			"	cities.the_geom, ",
			"	cities.the_geom_webmercator, ",
			"	cities.city_name, ",
			"	cities.government, ",
			"	sorted_poets.cityid, ",
			"	COUNT(sorted_poets.cityid) as selected_number, ",
			"	string_agg(sorted_poets.poet_name, ', ') as selected_names, ",
			"   	string_agg(sorted_poets.sources, ', ') as selected_sources, ",
			"	string_agg(sorted_poets.poet_link, ', ') as selected_links ",
			"FROM cities, ",
			"	(SELECT ",
			"		poets.poetid, ",
			"		poets.poet_name, ",
			"		poets.sources, ",
			"		poets.poet_link, ",
			"		poets_cities.cityid ",
			"		FROM poets, poets_cities ",
			"		WHERE poets.poetid = poets_cities.poetid ",
			"		ORDER BY cityid ASC, poet_name ASC) sorted_poets ",
			"WHERE cities.cityid = sorted_poets.cityid ",
			"GROUP BY sorted_poets.cityid, cities.the_geom, cities.the_geom_webmercator, cities.city_name, cities.cartodb_id"
		].join("");
		return query;
	}

	  function createBubbleVisualization(selectedData) {
		var bubble =
			['#cities{',
			  'marker-fill: #B81609;',
			  'marker-line-color: #FFF;',
			  'marker-line-width: 2;',
			  'marker-line-opacity: 1;',
			  'marker-opacity: 0.9;',
			  'marker-placement: point;',
			  'marker-type: ellipse;',
			  'marker-allow-overlap: true;',
			  'marker-clip: false;',
			  'marker-multi-policy: largest;',
			  'marker-width: 10.0;',
			'}',
/*			'#cities::labels ', 
			'[',selectedData,'>=8][zoom>5], ',
			'[',selectedData,'>=2][zoom>6], ',
			'[',selectedData,'>=1][zoom>7] ', 
			'{',
			'  text-name: [city_name];',
			'  text-face-name: "Open Sans Regular";',
			'  text-size: 15;',
			'  text-fill: #000;',
			'  text-allow-overlap: true;',
			'  text-halo-fill: #FFF;',
			'  text-halo-radius: 1;',
			'  text-placement-type: simple;',
			'  text-placements: "N,S,E,W,NE,SE,NW,SW,16,14,12";',
			'  text-dy: 3;',
			'  text-dx: 3;',
			'}',  */
			].join('');
		return bubble;
		}
	
      
      function getParameterByName(name) {
	  name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
	  var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
	      results = regex.exec(location.search);
	  return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
      }      
	  
      function main() {
        cartodb.createVis('map', 'http://greeklyricpoets.cartodb.com/api/v2/viz/5412ef5c-128d-11e3-8b55-8149b805c7e0/viz.json', {
          tiles_loader: false,
          center_lat: 38.95,
          center_lon: 22.38,
          zoom: 6
        })
        .done(function(vis, layers) {
	  // layer 0 is the base layer, layer 1 is cartodb layer
	  var sublayer = layers[1].getSubLayer(0);
	  var sublayer2;
	  var poetid = getParameterByName("poetid");
	  var query = createTotalPoetsQuery();
	  var css = createBubbleVisualization("selected_number");
	  
	  sublayer.set({ 'interactivity': ['cartodb_id', 'poet_name', 'birth_city_name', 'other_city_name', 'instrument_names', 'genre_names', 'date_names', 'sources'] });
	  
	  vis.addOverlay({
		  type: 'infobox',
		  template: "<h3>{{poet_name}}</h3><p>Place of birth: {{birth_city_name}}</p><p>Place of Performance: {{other_city_name}}</p><p>Genres: {{genre_names}}</p><p>Dates: {{date_names}}</p><p>Sources: {{sources}}</p>",
		  width: 300,
		  position: 'bottom|left'
	  });

	  layers[1].createSubLayer({sql: query, cartocss: css } );
	  sublayer2 = layers[1].getSubLayer(1);
	  sublayer2.set({ 'interactivity': ['cartodb_id', 'city_name', 'selected_number', 'selected_names', 'selected_sources'] });
	  sublayer2.infowindow.set('template', $('#infowindow_template').html());
	  
	  if (poetid != "") {
	    $("#poet_" + poetid).addClass('selected');
	    sublayer.setSQL("SELECT * FROM poets_lines WHERE poetid = " + poetid);
	    sublayer.setCartoCSS("#poets_lines { line-width: 3; marker-width: 10; }");
	    sublayer2.setSQL("SELECT cities.cartodb_id, cities.the_geom, cities.the_geom_webmercator, cities.city_name, cities.government, sorted_poets.cityid, COUNT(sorted_poets.cityid) as selected_number, string_agg(sorted_poets.sources, ', ') as selected_sources, string_agg(sorted_poets.poet_name, ', ') as selected_names, string_agg(sorted_poets.poet_link, ', ') as selected_links FROM cities, (SELECT poets.poetid, poets.poet_name, poets.poet_link, poets.sources, poets_cities.cityid FROM poets, poets_cities WHERE poets.poetid = poets_cities.poetid AND poets.poetid = " + poetid + " ORDER BY cityid ASC, poet_name ASC) sorted_poets WHERE cities.cityid = sorted_poets.cityid GROUP BY sorted_poets.cityid, cities.the_geom, cities.the_geom_webmercator, cities.city_name, cities.cartodb_id");
	  }
	  else {
	    $('#all_poets').addClass('selected');
	    sublayer.setSQL("SELECT * FROM poets_lines");
	  }
	  	  
	  createSelector(vis, layers);
        })
        .error(function(err) {
          console.log(err);
        });
      }

      window.onload = main;
    </script>
    
    <script src="bootstrap/js/jquery.js"></script>  
    <script src="bootstrap/js/bootstrap-dropdown.js"></script> 
  </body>
</html>